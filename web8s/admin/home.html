<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Qu·∫£n Tr·ªã ICOGroup</title>
    <link rel="stylesheet" href="add.css">
</head>

<body>

    <header class="top-bar">
        <a href="home.html" class="logo">Trang Qu·∫£n Tr·ªã ICOGroup</a>
        <div class="user-control">
            <button class="nav-item" onclick="logoutAdmin()">ƒêƒÉng Xu·∫•t</button>
        </div>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <div id="data-management-menu" class="menu-list active-menu">
                <h3>Qu·∫£n L√Ω D·ªØ Li·ªáu</h3>
                <ul>
                    <li class="menu-item active" data-view="user-list">üìã Danh s√°ch ƒë∆°n h√†ng</li>
                    <li class="menu-item" data-view="web-settings">‚öôÔ∏è Ch·ªânh s·ª≠a trang web</li>
                    <li class="menu-item" data-view="image-management">üñºÔ∏è Qu·∫£n l√Ω ·∫£nh</li>
                    <li class="menu-item" data-view="content-posts">‚úçÔ∏è Qu·∫£n l√Ω n·ªôi dung b√†i vi·∫øt</li>
                </ul>
            </div>
        </aside>

        <section class="content-area">
            <div id="user-list" class="content-view active-view">
                <h2>üìã Danh s√°ch Ng∆∞·ªùi d√πng ƒë√£ g·ª≠i th√¥ng tin</h2>
                <div class="table-controls" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo Ng√†y nh·∫≠n, T√™n, SƒêT, Ghi ch√∫..."
                        style="padding: 8px; border: 1px solid #ccc; flex-grow: 1;">
                    <button class="action-btn btn-update" onclick="exportUsersToTxt()">
                        üì• Xu·∫•t File TXT
                    </button>
                </div>

                <div id="message"></div>
                <div id="userTableContainer">
                    <p style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>

                <div id="editModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Ch·ªânh S·ª≠a Th√¥ng Tin Ng∆∞·ªùi D√πng</h2>
                        <form id="editUserForm">
                            <input type="hidden" id="edit-id" name="id">

                            <label for="edit-ho_ten">H·ªç v√† T√™n:</label>
                            <input type="text" id="edit-ho_ten" name="ho_ten" required>

                            <label for="edit-sdt">S·ªë ƒêi·ªán Tho·∫°i:</label>
                            <input type="tel" id="edit-sdt" name="sdt" required>

                            <label for="edit-nam_sinh">NƒÉm Sinh:</label>
                            <input type="number" id="edit-nam_sinh" name="nam_sinh">

                            <label for="edit-dia_chi">ƒê·ªãa Ch·ªâ:</label>
                            <input type="text" id="edit-dia_chi" name="dia_chi">

                            <label for="edit-chuong_trinh">Ch∆∞∆°ng Tr√¨nh:</label>
                            <select id="edit-chuong_trinh" name="chuong_trinh">
                                <option value="Du h·ªçc">Du h·ªçc</option>
                                <option value="Xu·∫•t kh·∫©u lao ƒë·ªông">Xu·∫•t kh·∫©u lao ƒë·ªông</option>
                                <option value="ƒê√†o t·∫°o ngo·∫°i ng·ªØ">ƒê√†o t·∫°o ngo·∫°i ng·ªØ</option>
                            </select>

                            <label for="edit-quoc_gia">Qu·ªëc Gia:</label>
                            <select id="edit-quoc_gia" name="quoc_gia">
                                <option value="Nh·∫≠t B·∫£n">Nh·∫≠t B·∫£n</option>
                                <option value="H√†n Qu·ªëc">H√†n Qu·ªëc</option>
                                <option value="ƒê√†i Loan">ƒê√†i Loan</option>
                                <option value="ƒê·ª©c">ƒê·ª©c</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>

                            <label for="edit-ghi_chu">Ghi Ch√∫:</label>
                            <input type="text" id="edit-ghi_chu" name="ghi_chu">


                            <button type="submit" class="btn-update action-btn"
                                style="width: 100%; margin-top: 15px;">L∆ØU THAY ƒê·ªîI</button>
                        </form>
                    </div>
                </div>

                <script>
                    const API_BASE_URL = '/web8s/backend_api/';
                    let allUsers = [];
                    const tableContainer = document.getElementById('userTableContainer');
                    const messageDisplay = document.getElementById('message');
                    const editModal = document.getElementById('editModal');
                    const editForm = document.getElementById('editUserForm');
                    const modalClose = document.getElementsByClassName("close")[0];

                    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
                    function showMessage(msg, isSuccess = true) {
                        messageDisplay.textContent = msg;
                        messageDisplay.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
                        messageDisplay.style.color = isSuccess ? '#155724' : '#721c24';
                    }

                    // ----------------------------------------------------------------------
                    // 1. CH·ª®C NƒÇNG ƒê·ªåC (READ)
                    // ----------------------------------------------------------------------

                    async function fetchUsers() {

                        tableContainer.innerHTML = '<p style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
                        showMessage("ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...", false);

                        try {
                            const response = await fetch(API_BASE_URL + 'get.php');
                            const users = await response.json();

                            if (response.ok && Array.isArray(users)) {
                                allUsers = users;
                                renderTable(allUsers);
                                showMessage(`T·∫£i th√†nh c√¥ng! C√≥ ${users.length} ng∆∞·ªùi d√πng.`, true);
                            } else if (response.ok && users.data && users.data.length === 0) {
                                tableContainer.innerHTML = '<p style="text-align:center; color:gray;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                                showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu ƒëƒÉng k√Ω n√†o.", true);
                            } else {
                                throw new Error(users.message || "L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ API.");
                            }
                        } catch (error) {
                            console.error('L·ªói Fetch:', error);
                            tableContainer.innerHTML = '<p style="text-align:center; color:red;">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Backend. Vui l√≤ng ki·ªÉm tra XAMPP!</p>';
                            showMessage(`L·ªói: ${error.message}`, false);
                        }
                    }

                    // H√†m v·∫Ω b·∫£ng HTML
                    function renderTable(dataToDisplay) {
                        if (dataToDisplay.length === 0) {
                            tableContainer.innerHTML = '<p style="text-align:center; color:gray;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                            return;
                        }

                        let tableHTML = '<table>';
                        tableHTML += '<thead><tr><th>ID</th><th>Ng√†y nh·∫≠n</th><th>H·ªç T√™n</th><th>SƒêT</th><th>NƒÉm Sinh</th><th>ƒê·ªãa Ch·ªâ</th><th>Ch∆∞∆°ng Tr√¨nh</th><th>Qu·ªëc Gia</th><th>Ghi Ch√∫</th><th>H√†nh ƒê·ªông</th></tr></thead>';
                        tableHTML += '<tbody>';

                        dataToDisplay.forEach(user => {

                            const formattedDate = user.ngay_nhan ? new Date(user.ngay_nhan).toLocaleString('vi-VN') : '-';

                            tableHTML += `
            <tr data-id="${user.id}">
                <td>${user.id}</td>
                <td>${formattedDate}</td>
                <td>${user.ho_ten}</td>
                <td>${user.sdt}</td>
                <td>${user.nam_sinh || '-'}</td>
                <td>${user.dia_chi || '-'}</td>
                <td>${user.chuong_trinh || '-'}</td>
                <td>${user.quoc_gia || '-'}</td>
                <td>${user.ghi_chu || '-'}</td>

                <td>
                    <button class="action-btn btn-update" onclick="openEditModal(
                            ${user.id},
                            '${user.ho_ten}',
                            '${user.sdt}',
                            '${user.nam_sinh}',
                            '${user.dia_chi}',
                            '${user.chuong_trinh}',
                            '${user.quoc_gia}',
                            '${user.ghi_chu}',
                        )">S·ª≠a</button>
                    <button class="action-btn btn-delete" onclick="deleteUser(${user.id})">X√≥a</button>
                </td>
            </tr>
            `;
                        });

                        tableHTML += '</tbody></table>';
                        tableContainer.innerHTML = tableHTML;
                    }

                    //----------------------------------------------------------------------------------------------------------------
                    // H√†m l·ªçc d·ªØ li·ªáu d·ª±a tr√™n input t√¨m ki·∫øm
                    function filterUsers() {
                        const searchTerm = searchInput.value.toLowerCase();

                        // L·ªçc m·∫£ng allUsers (d·ªØ li·ªáu g·ªëc)
                        const filteredUsers = allUsers.filter(user => {
                            // Chu·ªói ƒë·ªÉ t√¨m ki·∫øm (t√¨m ki·∫øm trong T√™n, SƒêT, Ghi ch√∫)
                            const searchString = `${user.ho_ten} ${user.sdt} ${user.ghi_chu} ${user.ngay_nhan}`.toLowerCase();
                            return searchString.includes(searchTerm);
                        });

                        // Hi·ªÉn th·ªã b·∫£ng v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
                        renderTable(filteredUsers);

                        // C·∫≠p nh·∫≠t th√¥ng b√°o
                        if (searchTerm.trim() !== "") {
                            showMessage(`T√¨m th·∫•y ${filteredUsers.length} k·∫øt qu·∫£.`, true);
                        } else {
                            showMessage(`T·∫£i th√†nh c√¥ng! C√≥ ${allUsers.length} ng∆∞·ªùi d√πng.`, true);
                        }
                    }

                    // Th√™m Listener cho √¥ t√¨m ki·∫øm
                    searchInput.addEventListener('keyup', filterUsers);

                    // -----------------------------------------------------------------------------------------------------------
                    // 2. CH·ª®C NƒÇNG X√ìA (DELETE)
                    // -----------------------------------------------------------------------------------------------------------

                    async function deleteUser(id) {
                        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng ID: ${id} kh√¥ng ? `)) {
                            return;
                        }

                        try {
                            const response = await fetch(API_BASE_URL + 'delete.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: id })
                            });

                            const result = await response.json();

                            if (response.ok && result.status === true) {
                                showMessage(`X√≥a ng∆∞·ªùi d√πng ID ${id} th√†nh c√¥ng.`, true);
                                // T·∫£i l·∫°i danh s√°ch sau khi x√≥a
                                fetchUsers();
                            } else {
                                throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi x√≥a.");
                            }

                        } catch (error) {
                            console.error('L·ªói Delete:', error);
                            showMessage(`‚ùå L·ªói x√≥a: ${error.message} `, false);
                        }
                    }

                    // -----------------------------------------------------------------------------------------------------
                    // 3. CH·ª®C NƒÇNG C·∫¨P NH·∫¨T (UPDATE)
                    // -------------------------------------------------------------------------------------------------------

                    // M·ªü Modal v√† ƒëi·ªÅn d·ªØ li·ªáu c≈© v√†o form
                    function openEditModal(id, ho_ten, sdt, nam_sinh, dia_chi, chuong_trinh, quoc_gia, ghi_chu, trang_thai) {
                        document.getElementById('edit-id').value = id;
                        document.getElementById('edit-ho_ten').value = ho_ten;
                        document.getElementById('edit-sdt').value = sdt;
                        document.getElementById('edit-nam_sinh').value = nam_sinh;
                        document.getElementById('edit-dia_chi').value = dia_chi;
                        document.getElementById('edit-chuong_trinh').value = chuong_trinh;
                        document.getElementById('edit-quoc_gia').value = quoc_gia;
                        document.getElementById('edit-ghi_chu').value = ghi_chu;

                        editModal.style.display = "block";
                    }

                    // ƒê√≥ng Modal khi click v√†o n√∫t X
                    modalClose.onclick = function () {
                        editModal.style.display = "none";
                    }

                    // ƒê√≥ng Modal khi click ra ngo√†i
                    window.onclick = function (event) {
                        if (event.target == editModal) {
                            editModal.style.display = "none";
                        }
                    }

                    // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "L∆ØU THAY ƒê·ªîI" trong Modal
                    editForm.addEventListener('submit', async function (event) {
                        event.preventDefault();

                        const updatedData = {
                            id: document.getElementById('edit-id').value,
                            ho_ten: document.getElementById('edit-ho_ten').value,
                            sdt: document.getElementById('edit-sdt').value,
                            nam_sinh: document.getElementById('edit-nam_sinh').value,
                            dia_chi: document.getElementById('edit-dia_chi').value,
                            chuong_trinh: document.getElementById('edit-chuong_trinh').value,
                            quoc_gia: document.getElementById('edit-quoc_gia').value,
                            ghi_chu: document.getElementById('edit-ghi_chu').value,
                        };

                        showMessage("ƒêang l∆∞u thay ƒë·ªïi...", false);

                        try {
                            const response = await fetch(API_BASE_URL + 'update.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedData)
                            });

                            const result = await response.json();

                            if (response.ok && result.status === true) {
                                showMessage(result.message, true);
                                editModal.style.display = "none";
                                fetchUsers();
                            } else {
                                throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi c·∫≠p nh·∫≠t.");
                            }

                        } catch (error) {
                            console.error('L·ªói Update:', error);
                            showMessage(`‚ùå L·ªói c·∫≠p nh·∫≠t: ${error.message} `, false);
                        }
                    });
                    // ----------------------------------------------------------------------
                    // 4. CH·ª®C NƒÇNG XU·∫§T FILE TXT
                    // ----------------------------------------------------------------------
                    async function exportUsersToTxt() {
                        // 1. L·∫•y t·∫•t c·∫£ c√°c ID ƒëang hi·ªÉn th·ªã trong b·∫£ng (sau khi ƒë√£ l·ªçc)
                        const rows = document.querySelectorAll('#userTableContainer tbody tr');
                        const filteredIds = Array.from(rows).map(row => row.getAttribute('data-id'));

                        if (filteredIds.length === 0) {
                            showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã ƒë·ªÉ xu·∫•t file!", false);
                            return;
                        }

                        showMessage("ƒêang chu·∫©n b·ªã xu·∫•t file...", true);

                        try {
                            const response = await fetch(API_BASE_URL + 'export.php', {
                                method: 'POST', // Chuy·ªÉn sang POST ƒë·ªÉ g·ª≠i m·∫£ng ID
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ids: filteredIds })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`L·ªói API: ${response.status}`);
                            }

                            const result = await response.json();

                            if (result.status === true && result.file_url) {
                                // T·∫°o link t·∫£i file
                                const fullUrl = API_BASE_URL.replace('/backend_api/', '/') + result.file_url;
                                const link = document.createElement('a');
                                link.href = fullUrl;
                                link.download = result.file_url.split('/').pop();
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showMessage("Xu·∫•t file th√†nh c√¥ng!", true);
                            } else {
                                throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh.");
                            }
                        } catch (error) {
                            console.error('L·ªói Export:', error);
                            showMessage(`‚ùå L·ªói xu·∫•t file: ${error.message}`, false);
                        }
                    }
                    // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
                    document.addEventListener('DOMContentLoaded', fetchUsers);
                    // ----------------------------------------------------

                    // H√†m hi·ªÉn th·ªã th√¥ng b√°o cho ph·∫ßn n·ªôi dung (d√πng id='content-message')
                    function showContentMessage(msg, isSuccess = true) {
                        const display = document.getElementById('content-message');
                        if (display) {
                            display.textContent = msg;
                            display.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
                            display.style.color = isSuccess ? '#155724' : '#721c24';
                            display.style.padding = '10px';
                            display.style.borderRadius = '5px';
                        }
                    }

                    // ----------------------------------------------------
                    // CH·ª®C NƒÇNG T·∫¢I V√Ä L∆ØU N·ªòI DUNG WEB
                    // ----------------------------------------------------

                    // 4.1. T·∫£i n·ªôi dung hi·ªán t·∫°i v√† ƒëi·ªÅn v√†o form
                    async function fetchAllContent() {
                        try {
                            const response = await fetch(API_BASE_URL + 'get_content.php');
                            const contents = await response.json();

                            if (response.ok && Array.isArray(contents)) {
                                contents.forEach(item => {
                                    // S·ª¨A L·ªñI C√ö PH√ÅP: B·ªè d·∫•u c√°ch th·ª´a
                                    const inputElement = document.querySelector(`[data-key="${item.section_key}"]`);
                                    if (inputElement) {
                                        inputElement.value = item.content_value;
                                    }
                                });
                            } else {
                                throw new Error(contents.message || "L·ªói khi t·∫£i n·ªôi dung web.");
                            }
                        } catch (error) {
                            console.error('L·ªói Fetch Content:', error);
                            showMessage(`‚ùå L·ªói t·∫£i n·ªôi dung: ${error.message} `, false);
                        }
                    }

                    // 4.2. L∆∞u m·ªôt c·∫∑p key/value
                    async function saveContent(key, value) {
                        try {
                            const response = await fetch(API_BASE_URL + 'save_content.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ section_key: key, content_value: value })
                            });
                            const result = await response.json();

                            if (!response.ok || result.status !== true) {
                                throw new Error(result.message || `L·ªói c·∫≠p nh·∫≠t ${key}.`);
                            }
                            return true;
                        } catch (error) {
                            console.error(`L·ªói l∆∞u n·ªôi dung ${key}: `, error);
                            return false;
                        }
                    }

                    // 4.3. L∆∞u t·∫•t c·∫£ n·ªôi dung trong form
                    async function saveAllContent() {
                        showContentMessage("ƒêang l∆∞u t·∫•t c·∫£ n·ªôi dung...", false);
                        const contentInputs = document.querySelectorAll('#editContentForm .content-input');
                        let successCount = 0;
                        let failCount = 0;

                        for (const input of contentInputs) {
                            const key = input.getAttribute('data-key');
                            const value = input.value;

                            const isSuccess = await saveContent(key, value);
                            if (isSuccess) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        }

                        if (failCount === 0) {
                            showContentMessage(`üéâ L∆∞u t·∫•t c·∫£ n·ªôi dung th√†nh c√¥ng!(${successCount} m·ª•c ƒë∆∞·ª£c c·∫≠p nh·∫≠t).`, true);
                        } else {
                            showContentMessage(`‚ö†Ô∏è Ho√†n th√†nh! ${successCount} m·ª•c th√†nh c√¥ng, ${failCount} m·ª•c th·∫•t b·∫°i.Vui l√≤ng ki·ªÉm tra Console.`, false);
                        }
                    }

                    // T·ª± ƒë·ªông t·∫£i n·ªôi dung khi chuy·ªÉn sang tab Qu·∫£n l√Ω N·ªôi dung
                    // B·∫°n c·∫ßn th√™m logic n√†y v√†o h√†m chuy·ªÉn tab c·ªßa Admin
                    document.querySelector('[data-content="web-content-management"]').addEventListener('click', fetchAllContent);
                </script>

            </div>
            <div id="web-settings" class="content-view">
                <h2>‚öôÔ∏è Ch·ªânh s·ª≠a n·ªôi dung trang web</h2>
                <div id="content-message"></div>
                <form id="editContentForm">
                    <h3>1. Ph·∫ßn BANNER</h3>
                    <textarea data-key="banner_text" class="content-input" rows="2"></textarea>
                    <button type="button" onclick="saveAllContent()" class="btn-update action-btn">L∆ØU T·∫§T C·∫¢</button>
                </form>
            </div>

            <div id="image-management" class="content-view">
                <h2>üñºÔ∏è Th∆∞ Vi·ªán ·∫¢nh T·∫≠p Trung</h2>

                <div class="table-controls"
                    style="background: #f4f4f4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin-bottom: 10px; font-weight: bold;">T·∫£i ·∫£nh m·ªõi l√™n h·ªá th·ªëng:</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="file" id="uploadInput" accept="image/*" multiple style="padding: 5px;">
                        <button class="action-btn btn-update" onclick="uploadImages()">üì§ B·∫Øt ƒë·∫ßu t·∫£i l√™n</button>
                    </div>
                    <div id="uploadStatus" style="margin-top: 10px; font-size: 14px;"></div>
                </div>

                <div id="imageGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    <p style="text-align: center; grid-column: 1/-1;">ƒêang t·∫£i th∆∞ vi·ªán ·∫£nh...</p>
                </div>

                

            </div>

            <div id="content-posts" class="content-view">
                <h2>‚úçÔ∏è Qu·∫£n l√Ω n·ªôi dung b√†i vi·∫øt</h2>
                <p>Danh s√°ch c√°c b√†i vi·∫øt tin t·ª©c.</p>
            </div>

        </section>
    </main>

    <script src="add.js"></script>
</body>

</html>